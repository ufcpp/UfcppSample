# TextTemplatingFilePreprocessor 要らない説

## 背景

* TextTemplatingFilePreprocessor = 実行時テキストテンプレートって言われてるやつ
* TextTemplatingFilePreprocessor は、まあ、元々あんまり使われてる気配を感じてない
  * T4 自体あんまり使われてない疑惑も
* まして、C# 11 なら `$""" """` 使えば十分

## この sln

* T4 と文字列補間で同じテキスト生成してみる
* BenchmarkDotNet にかけてみる

## 結果

手元の環境での BenchmarkDotNet 実行結果:

|        Method |        Mean |    Error |   StdDev |
|-------------- |------------:|---------:|---------:|
|            T4 | 19,247.7 ns | 74.46 ns | 69.65 ns |
| Interpolation |    330.6 ns |  5.94 ns |  5.55 ns |

メソッド名通り、

* T4: T4 テンプレートを使用
* Interpolation: 文字列補間を使用

さすがに2桁違いは…

## 原因

C# 10 移行、文字列補間が超高速化されたというのもあり。

T4 の生成するコードが悲惨というのもあり。
`<#= #>` に渡したオブジェクト1個1個に対して以下のメソッドが呼ばれてる。

```cs
public string ToStringWithCulture(object objectToConvert)
{
    if ((objectToConvert == null))
    {
        throw new global::System.ArgumentNullException("objectToConvert");
    }
    System.Type t = objectToConvert.GetType();
    System.Reflection.MethodInfo method = t.GetMethod("ToString", new System.Type[] {
                typeof(System.IFormatProvider)});
    if ((method == null))
    {
        return objectToConvert.ToString();
    }
    else
    {
        return ((string)(method.Invoke(objectToConvert, new object[] {
                    this.formatProviderField })));
    }
}
```

カルチャー対応のためだけにリフレクション…
しかも、都度 `Type.GetMethod` を呼ぶところから…

## 脱 T4 のメリット・デメリット

脱 T4 メリット

* 速い
* 普通の C# だけで書ける
  * 補完・コード解析が働く
* Visual Studio 以外で使える
  * 「Visual Studio 上で保存時にコード生成」がきつかった
  * この Roslyn Source Generator な時代に、誰も Source Generator 化しないあたりでお察し
* csproj がすっきり
  * `<None Update="T4Generator.tt">` みたいな謎タグ要らない
  * `<Service Include="{508349b6-6b84-4df5-91f0-309beebad82d}" />` とかいう謎サービス要らない
  * `<PackageReference Include="System.CodeDom" />` とかいうつらみあるパッケージ参照要らない
* Visual Studio 自体のバージョン・表示言語に依存しない
  * TextTemplatingFilePreprocessor の生成結果はは「T4 ファイルを編集して保存した PC」に依存しちゃう
  * 複数人編集すると Git 差分が悲惨なことになってた

脱 T4 デメリット

* 文字列補間、そこまできれいな文法じゃない
  * T4 でもそこまで読みやすくはないんで、好みによるかも

## 脱 T4 手法

結構機械的な置換が可能。

```cs
using System.Text.RegularExpressions;

static partial class RepalceT4
{
    public static string Replace(string x)
    {
        x = A().Replace(x, m => "{{" + m.Groups[1].Value + "}}");
        x = C().Replace(x, """"
                    s.Append($$$$"""
            """");
        x = B().Replace(x, """"

            """);
            """");

        var y = """"
                        
                public string TransformText()
                {
                    var s = new StringBuilder();

                    s.Append($$"""
            //《Generated by .tt》
            
            """"
            + x +
            """"

            """);

                return s.ToString();
            }

            """";
        return y;
    }

    [GeneratedRegex("""
        \<\#\=(.*?)\#\>
        """, RegexOptions.Multiline)]
    private static partial Regex A();

    [GeneratedRegex("""
        ^\<\#
        """, RegexOptions.Multiline)]
    private static partial Regex B();

    [GeneratedRegex("""
        ^\#\>
        """, RegexOptions.Multiline)]
    private static partial Regex C();
}
```

条件演算子(` ? : `)が入ってるとちょっとコンパイルエラーを起こすとか、
`<#+ #>` に対応していないとか細かい機能不足はあるものの、
手作業調整で済む範囲。

ちなみに、クリップボードからの貼り付け:

```cs
using System.Windows;

class Program
{
    [STAThread]
    static void Main()
    {
        var x = Clipboard.GetText();
        Clipboard.SetText(RepalceT4.Replace(x));
    }
}
```
